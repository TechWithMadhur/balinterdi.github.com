
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Shoulda: setup and should blocks and don't wander off the map - alint Erdi</title>
  <meta name="author" content="Balint Erdi">

  
  <meta name="description" content="I&#8217;m using shoulda for testing in a rails project and I wrote this simple test to see if my update action really updated the object and &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://balinterdi.com/2009/01/28/shoulda-blocks-active-record-macros-and-their-order.html">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/balinterdi" rel="alternate" title="alint Erdi" type="application/atom+xml">
  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-12299794-2']);
    _gaq.push(['_setSiteSpeedSampleRate', 100]); // profile all visitors
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Balint Erdi</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/balinterdi" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:balinterdi.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul role=main-navigation>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Shoulda: Setup and Should Blocks and Don't Wander Off the Map</h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-01-28T00:00:00+01:00" pubdate data-updated="true">Jan 28<span>th</span>, 2009</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I&#8217;m using <a href="http://www.thoughtbot.com/projects/shoulda/">shoulda</a> for testing in a rails project and I wrote this simple test to see if my update action really updated the object and redirected to the appropriate place:</p>

<pre lang="ruby">
context "the update" do
  setup do     # 1
    @project = Factory(:project, :director => @user)
    put :update, :id => @project, :project => { :name => "updated name" }
  end
  # 2    
  updated_project = Project.first(:order => "created_at DESC")
  # 3
  should_redirect_to "project_url(updated_project)" # 4
  should "update the attributes" do
    assert_equal("updated name", updated_project.name) # 5
  end  
end
</pre>


<p>To my surprise, I received an &#8220;undefined local variable or method &#8216;updated_project&#8217; on both tests (#4 and #5). I figured out why and I want to share it with you. In case you are a shoulda expert, you must know the answer already and sorry for wasting your time. On the other hand, if you are new to shoulda like I am, you may find this useful.</p>

<p>What shoulda does when running a &#8216;should&#8217; block is that it runs all the &#8216;setup&#8217; blocks of the contexts in which it is nested, from the outside to the inside, so this:</p>

<pre lang="ruby">
context "alpha" do
  setup do
    puts "A"
  end
  context "beta" do
    setup do
      puts "B"
    end
    context "gamma" do
      setup do
        puts "C"
      end
      should "work" do
         puts "the only test"
      end
    end
  end
end
</pre>


<p>Will print</p>

<pre lang="bash">
A
B
C
the only test
</pre>


<p>Also the area between #2 and #3 in the above test is sort of a no man&#8217;s land, since it is not in a setup block, so assignments that are executed here are completely useless. You can not use it either for side-effects since it will run before the setup block (#1 above). My advice is to simply put everything in a block, be it a &#8216;setup&#8217; or a &#8216;should&#8217; one. (the &#8216;should_redirect_to&#8217; is a macro that&#8217;s part of shoulda, it gets expanded into a block, too).</p>

<p>So here is the same test correctly:</p>

<pre lang="ruby">
context "the update" do
  setup do
    @project = Factory(:project, :director => @user)
    put :update, :id => @project, :project => { :name => "updated name" }
  end
  
  should_redirect_to "project_url(@project)" 
  should "update the attributes" do
    # reload is needed to see the new state
    @project.reload
    assert_equal("updated name", @project.name)
  end
  
end
</pre>


<p>Shoulda is a nice tool. There is only one I know and I like a tad better which is quite similar in structure, <a href="http://rspec.info/documentation/">rspec</a>.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Balint Erdi</span></span>

      








  


<time datetime="2009-01-28T00:00:00+01:00" pubdate data-updated="true">Jan 28<span>th</span>, 2009</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://balinterdi.com/2009/01/28/shoulda-blocks-active-record-macros-and-their-order.html" data-via="baaz" data-counturl="http://balinterdi.com/2009/01/28/shoulda-blocks-active-record-macros-and-their-order.html" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2009/01/25/mysql-table-types-and-foreign-key-constraints.html" title="Previous Post: MySQL table types and foreign key constraints">&laquo; MySQL table types and foreign key constraints</a>
      
      
        <a class="basic-alignment right" href="/2009/02/04/strings-as-haml-render-parameters-in-sinatra-do-not-work.html" title="Next Post: strings as haml render parameters in Sinatra do not work">strings as haml render parameters in Sinatra do not work &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Contact</h1>
  <div>
    Do you have a project that needs help?  <a href="mailto:balint@balinterdi.com"> Write to me</a> and let's start talking.
  </div>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2013/11/27/profile-your-ember-app-with-ember-renderspeed.html">Profile your Ember app with ember-renderspeed</a>
      </li>
    
      <li class="post">
        <a href="/2013/08/23/find-and-replace-in-all-files.html">Find and Replace in all files</a>
      </li>
    
      <li class="post">
        <a href="/2013/06/19/the-appeal-of-one-paradigm-languages.html">The appeal of one paradigm languages</a>
      </li>
    
      <li class="post">
        <a href="/2013/06/02/install-ruby-2-dot-0-0-with-rbenv-ruby-build-on-mountain-lion.html">Install Ruby 2.0.0 with rbenv (ruby-build) on Mountain Lion</a>
      </li>
    
      <li class="post">
        <a href="/2013/05/30/ruby-rogues-discourse-with-jeff-atwood.html">Ruby Rogues - Discourse with Jeff Atwood</a>
      </li>
    
  </ul>
</section>


<section>
  
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/baaz" class="twitter-follow-button" data-show-count="false">Follow @baaz</a>
  
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/117539684268982718923?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Balint Erdi -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'codigoergosum';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





<script src="//s3.amazonaws.com/scripts.hellobar.com/fc110d5cbe7d6afab1766e88f2220453d7a4c947.js" type="text/javascript"></script>



</body>
</html>
